#  Документация по сервису метрик Optimacros

ИС Optimacros предоставляет доступ к сервису метрик основных параметров приложения по протоколу HTTP (для использования в системах Prometheus, Zabbix и т.п.).

Сервис метрик доступен по следующим точкам доступа:
- **/api/v1/metrics** (предоставляет метрики в формате [**JSON**](#metrics-json))
- **/api/v1/metrics/prometheus** (предоставляет метрики в формате [**Prometheus**](#metrics-prometheus))

Основные метрики приложения:
- системные (system)
  - [**system_cpu_load**](#metrics_system_cpu_load) - степень загруженности процессора в процентах от 0 до 100
  - [**system_memory_used**](#metrics_system_memory_used) - размер использованной памяти
- ворскспейс (workspace)
  - [**workspace_memory_allocated**](#metrics_workspace_memory_allocated) - размер занятой памяти
  - [**workspace_memory_allowance**](#metrics_workspace_memory_allowance) - максимальный размер занятой памяти
  - [**workspace_memory_total**](#metrics_workspace_memory_total) - размер общедоступной памяти
  - [**workspace_users_total**](#metrics_workspace_users_total) - количество всех пользователей
  - [**workspace_users_active**](#metrics_workspace_users_active) - количество залогиненных и активных пользователей
  - [**workspace_users_modeler**](#metrics_workspace_users_modeler) - количество пользователей-моделеров
  - [**workspace_users_non_modeler**](#metrics_workspace_users_non_modeler) - количество обычных пользователей
  - [**workspace_backups_count**](#metrics_workspace_backups_count) - количество созданных бэкапов
  - [**workspace_backups_size**](#metrics_workspace_backups_size) - размер созданных бэкапов
  - [**workspace_backups_size_limit**](#metrics_workspace_backups_size_limit) - лимит пространства для бэкапов
  - [**workspace_backups_tasks_failed**](#metrics_workspace_backups_tasks_failed) - количество провальных задач бэкапирования в системе
- модели (models)
  - [**models_counter_total**](#metrics_models_counter_total) - общее количество моделей в системе
  - [**models_counter_online**](#metrics_models_counter_online) - количество доступных моделей (online)
  - [**models_counter_offline**](#metrics_models_counter_offline) - количество недоступных моделей (offline)
- запросы (requests)
  - [**requests_number**](#metrics_requests_number) - количество запросов (мгновенное значение (RPS))
  - [**requests_history_number**](#metrics_requests_history_number) - общее количество запросов (по истории)
  - [**requests_history_time_minimum**](#metrics_requests_history_time_minimum) - минимальное время выполнения запросов
  - [**requests_history_time_maximum**](#metrics_requests_history_time_maximum) - максимальное время выполнения запросов
  - [**requests_history_time_average**](#metrics_requests_history_time_average) - среднее время выполнения запросов
  - [**requests_history_time_median**](#metrics_requests_history_time_median) - медиана времени выполнения запросов

## Метрики в формате JSON <a name="metrics-json"></a>

Точка доступа **/api/v1/metrics** предоставляет метрики в формате <a href="https://habr.com/ru/articles/554274/#json_object">**JSON**</a>.
<br>Чтобы получить данные, нужно отправить GET запрос по данному адресу Воркспейса.

Пример метрик в формате JSON:<br>
![Metrics JSON](./pics/metrics_json.png)

## Метрики в формате Prometheus <a name="metrics-prometheus"></a>

Точка доступа **/api/v1/metrics/prometheus** предоставляет метрики в формате <a href="https://prometheus.io/docs/instrumenting/exposition_formats/">**Prometheus**</a>.
<br>Чтобы получить данные, нужно отправить GET запрос по данному адресу Воркспейса.

Пример метрик в формате Prometheus:<br>
![Metrics Prometheus](./pics/metrics_prometheus.png)

## Детали метрик

### Системные метрики

#### system_cpu_load <a name="metrics_system_cpu_load"></a>

Данная метрика предоставляет информацию о загруженности процессора (в процентах - от 0% до 100%) компьютера, на котором работает воркспейс.
<br>Метрика представлена целым числом от 0 (минимальное значение) до 100 (максимальное значение).

#### system_memory_used <a name="metrics_system_memory_used"></a>

Данная метрика предоставляет информацию об использованной оперативной памяти компьютера, на котором работает воркспейс.
<br>Метрика представлена целым числом и показывает размер использованной памяти в байтах.

### Метрики воркспейса

#### workspace_memory_allocated <a name="metrics_workspace_memory_allocated"></a>

Данная метрика предоставляет информацию об использованной оперативной памяти на компьютере, где работает воркспейс. Т.е. отображает размер оперативной памяти, занимаемый всеми моделями, хранящимися на воркспейсе.
<br>Метрика представлена целым числом и показывает размер использованной памяти в байтах.
<br>Данная картинка показывает пример использованной оперативной памяти и связанные метрики:
<br>![Workspace Memory](./pics/workspace_memory.png)

#### workspace_memory_allowance <a name="metrics_workspace_memory_allowance"></a>

Данная метрика предоставляет информацию об лимите оперативной памяти на компьютере, где работает воркспейс.
<br>Метрика представлена целым числом и показывает размер памяти в байтах.
<br>Приближение использованной оперативной памяти к данному лимиту указывает на увеличение размера воркспейса, возможно следует задуматься об удалении некоторых моделей или об увеличении размера оперативной памяти на компьютере.

#### workspace_memory_total <a name="metrics_workspace_memory_total"></a>

Данная метрика предоставляет информацию о размере общей доступной оперативной памяти на компьютере, где работает воркспейс.
<br>Метрика представлена целым числом и показывает размер памяти в байтах.
<br>Использованная оперативная память физически не может быть больше доступной оперативной памяти.

#### workspace_users_total <a name="metrics_workspace_users_total"></a>

Данная метрика предоставляет информацию об общем количестве пользователей, имеющих доступ к воркспейсу.
<br>Метрика представлена целым числом.

#### workspace_users_active <a name="metrics_workspace_users_active"></a>

Данная метрика предоставляет информацию о количестве пользователей, которые залогинены в системе и активны в воркспейс в данный момент времени.
<br>Метрика представлена целым числом.

#### workspace_users_modeler <a name="metrics_workspace_users_modeler"></a>

Данная метрика предоставляет информацию об общем количестве **пользователей-моделеров**, имеющих доступ к воркспейсу.
<br>Метрика представлена целым числом.

#### workspace_users_non_modeler <a name="metrics_workspace_users_non_modeler"></a>

Данная метрика предоставляет информацию об общем количестве **обычных** пользователей (не моделеров), имеющих доступ к воркспейсу.
<br>Метрика представлена целым числом.

#### workspace_backups_count <a name="metrics_workspace_backups_count"></a>

Данная метрика предоставляет информацию об общем количестве созданных бэкапов моделей.
<br>Метрика представлена целым числом.

#### workspace_backups_size <a name="metrics_workspace_backups_size"></a>

Данная метрика предоставляет информацию о размере дисковой памяти на компьютере, которую занимают все созданные бэкапы моделей.
<br>Метрика представлена целым числом и показывает размер памяти в байтах.

#### workspace_backups_size_limit <a name="metrics_workspace_backups_size_limit"></a>

Данная метрика предоставляет информацию о лимите дисковой памяти на компьютере, которую занимают все созданные бэкапы моделей. 
<br>Метрика представлена целым числом и показывает размер памяти в байтах.
<br>Приближение использованной дисковой памяти, занятой созданными бэкапами моделей, к данному лимиту указывает на возможные проблемы с созданием бэкапов моделей, возможно следует задуматься об удалении бэкапов моделей или об увеличении дискового пространства на компьютере.

#### workspace_backups_tasks_failed <a name="metrics_workspace_backups_count"></a>

Данная метрика предоставляет информацию об общем количестве провальных задач создания бэкапов моделей в системе.
<br>Метрика представлена целым числом.

### Метрики моделей

#### models_counter_total <a name="metrics_models_counter_total"></a>

Данная метрика предоставляет информацию об общем количестве моделей, созданных в воркспейсе.
<br>Метрика представлена целым числом.

#### models_counter_online <a name="metrics_models_counter_online"></a>

Данная метрика предоставляет информацию о количестве моделей в статусе **online** (доступны для работы).
<br>Метрика представлена целым числом.

#### models_counter_offline <a name="metrics_models_counter_offline"></a>

Данная метрика предоставляет информацию о количестве моделей в статусе **offline** (недоступны для работы).
<br>Метрика представлена целым числом.

### Метрики запросов

#### requests_number <a name="metrics_requests_number"></a>

Данная метрика предоставляет информацию о количестве клиентских запросов, зарегистрированных в данный момент времени в воркспейсе.
<br>Метрика представлена целым числом.

#### requests_history_number <a name="metrics_requests_history_number"></a>

Данная метрика предоставляет информацию о количестве клиентских запросов, исполнявшихся в воркспейсе в течении последних 5 минут.
<br>Метрика представлена целым числом.

#### requests_history_time_minimum <a name="metrics_requests_history_time_minimum"></a>

Данная метрика предоставляет информацию о **минимальном** времени выполнения клиентских запросов, исполнявшихся в воркспейсе в течении последних 5 минут.
<br>Метрика представлена числом с плавающей точкой.

#### requests_history_time_maximum <a name="metrics_requests_history_time_maximum"></a>

Данная метрика предоставляет информацию о **максимальном** времени выполнения клиентских запросов, исполнявшихся в воркспейсе в течении последних 5 минут.
<br>Метрика представлена числом с плавающей точкой.

#### requests_history_time_average <a name="metrics_requests_history_time_average"></a>

Данная метрика предоставляет информацию о **среднем** времени выполнения клиентских запросов, исполнявшихся в воркспейсе в течении последних 5 минут.
<br>Метрика представлена числом с плавающей точкой.
<br>Среднее время является адекватной мерой только в случае нормального распределения выборки, поскольку оно слишком чувствительно к «выбросам» – слишком большим или слишком малым значениям, которые сильно выбиваются из общей тенденции.

#### requests_history_time_median <a name="metrics_requests_history_time_median"></a>

Данная метрика предоставляет информацию о **медиане** времени выполнения клиентских запросов, исполнявшихся в воркспейсе в течении последних 5 минут.
<br>Метрика представлена числом с плавающей точкой.
<br>Медиана является серединой всей выборки времён ответов (см. <a href="https://habr.com/ru/companies/yoomoney/articles/433436/">Введение в исследование производительности</a>). В идеальной ситуации медиана и среднее равны. Если среднее сильно отличается от медианы, значит некоторые запросы выполнялись слишком медленно или слишком быстро, т.е. отклонялись от среднего значения. 

## Глоссарий

**JSON** — текстовый формат обмена данными, <a href="https://habr.com/ru/articles/554274/#json_object">основанный</a> на JavaScript.

**Ворскспейс (workspace)** – приложение (ПО «Оптимакрос»), на котором пользователи размещают свои модели и проводят работу с данными.

**Модель** – совокупность структур данных, связанных между собой, в виде мастер-данных, форм ввода, отчетов и визуализации, ограниченных конкретной областью (физической и логической (предметной)).

**Статус модели** – модель может быть в статусе online (доступна для работы) или offline (недоступна для работы).

**Моделер** - продвинутый пользователь ПО «Оптимакрос», который имеет доступ к инструментам и механизмам бизнес-моделированию ПО «Оптимакрос».

**Запрос (request)** – процесс обращения пользователя через систему ПО «Оптимакрос» к определенному функционалу системы.

**Бэкап (backup)** – резервная копия модели.

**Prometheus** - это система мониторинга и оповещений, хранящая и обрабатывающая метрики, собираемые из экспортеров в Time Series Database (TSDB). Prometheus сам собирает метрики, опрашивая необходимые сайты, предоставляющие метрики.

**Zabbix** - это программное обеспечение для мониторинга многочисленных параметров сети, жизнеспособности и целостности серверов, приложений, сервисов. Zabbix использует гибкий механизм оповещений, что позволяет пользователям настраивать уведомления основанные на e-mail практически на любое событие.

